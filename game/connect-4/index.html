<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Connect 4</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f0f4f7;
      font-family: 'Arial', sans-serif;
      margin: 0;
      flex-direction: column;
      touch-action: manipulation;
      user-select: none;
    }

    h1 {
      color: #2a9d8f;
      margin-bottom: 10px;
      font-size: 24px;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 10px;
      width: 90vw;
      max-width: 400px;
    }

    .column {
      display: flex;
      flex-direction: column;
    }

    .cell {
      aspect-ratio: 1/1;
      background-color: #e9ecef;
      border-radius: 50%;
      border: 2px solid #343a40;
      transition: background-color 0.1s ease-in-out;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cell.player1 {
      background-color: #e63946;
    }

    .cell.ai {
      background-color: #457b9d;
    }

    #status {
      font-size: 18px;
      font-weight: bold;
      color: #264653;
      margin-bottom: 10px;
    }

    .player-indicator {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .player-color {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .player1-color {
      background-color: #e63946;
    }

    .ai-color {
      background-color: #457b9d;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: white;
      font-weight: bold;
      flex-direction: column;
      z-index: 1000;
    }

    #overlay button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #2a9d8f;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Fast Connect 4</h1>

  <div class="player-indicator">
    <div><span class="player-color player1-color"></span>You</div>
    <div><span class="player-color ai-color"></span>AI</div>
  </div>

  <div id="board"></div>
  <div id="status">Your turn</div>

  <div id="overlay">
    <div id="overlay-message"></div>
    <button id="play-again">Play Again</button>
  </div>

  <script>
    const board = document.getElementById('board');
    const status = document.getElementById('status');
    const overlay = document.getElementById('overlay');
    const overlayMessage = document.getElementById('overlay-message');
    const playAgainButton = document.getElementById('play-again');
    const androidInterfaceExists = typeof AndroidInterface !== 'undefined';
    
    const rows = 6;
    const cols = 7;
    let boardArray = Array(rows).fill().map(() => Array(cols).fill(0));
    let currentPlayer = 1;
    let isGameOver = false;
    let aiDifficulty = 'hard';

    function initBoard() {
      board.innerHTML = '';
      for (let c = 0; c < cols; c++) {
        const column = document.createElement('div');
        column.classList.add('column');
        for (let r = 0; r < rows; r++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          cell.dataset.row = r;
          cell.dataset.col = c;
          column.appendChild(cell);
        }
        column.addEventListener('click', () => handleColumnClick(c));
        board.appendChild(column);
      }
    }

    function handleColumnClick(col) {
      if (isGameOver || currentPlayer !== 1) return;
      const row = getLowestEmptyRow(col);
      if (row !== -1) {
        dropPiece(row, col, currentPlayer);
      }
    }

    function getLowestEmptyRow(col) {
      for (let r = rows - 1; r >= 0; r--) {
        if (boardArray[r][col] === 0) return r;
      }
      return -1;
    }

    function dropPiece(row, col, player) {
      boardArray[row][col] = player;
      animatePieceDrop(row, col, player);
      if (checkWinner(row, col, player)) {
        endGame(`${player === 1 ? 'You' : 'AI'} Win!`);
        sendGameOverUpdate(`${player === 1 ? 'You' : 'AI'} Win!`)
      } else if (isBoardFull()) {
        endGame("It's a tie!");
        sendGameOverUpdate("It's a tie!")
      } else {
        currentPlayer = 3 - currentPlayer; // Switch between 1 and 2
        updateStatus();
        if (currentPlayer === 2) {
          setTimeout(aiMove, 100); // Faster AI move
        }
      }
    }
    function sendGameOverUpdate(msg){
      if(androidInterfaceExists){        
            AndroidInterface.onGameOver("Breakout score: "+msg);
        }
    }

    function animatePieceDrop(row, col, player) {
      const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
      cell.classList.add(player === 1 ? 'player1' : 'ai');
    }

    function checkWinner(row, col, player) {
      const directions = [[0, 1], [1, 0], [1, 1], [1, -1]];
      return directions.some(([dx, dy]) => {
        const count = 1 + countDirection(row, col, player, dx, dy) + countDirection(row, col, player, -dx, -dy);
        return count >= 4;
      });
    }

    function countDirection(row, col, player, dx, dy) {
      let count = 0;
      for (let i = 1; i < 4; i++) {
        const newRow = row + i * dy;
        const newCol = col + i * dx;
        if (newRow < 0 || newRow >= rows || newCol < 0 || newCol >= cols || boardArray[newRow][newCol] !== player) break;
        count++;
      }
      return count;
    }

    function isBoardFull() {
      return boardArray[0].every(cell => cell !== 0);
    }

    function aiMove() {
      const col = aiDifficulty === 'hard' ? aiHardMove() : aiEasyMove();
      const row = getLowestEmptyRow(col);
      if (row !== -1) {
        dropPiece(row, col, currentPlayer);
      }
    }

    function aiEasyMove() {
      const validCols = boardArray[0].reduce((acc, cell, index) => cell === 0 ? [...acc, index] : acc, []);
      return validCols[Math.floor(Math.random() * validCols.length)];
    }

    function aiHardMove() {
      for (let player of [2, 1]) { // Check for AI win, then player block
        for (let c = 0; c < cols; c++) {
          const r = getLowestEmptyRow(c);
          if (r !== -1) {
            boardArray[r][c] = player;
            if (checkWinner(r, c, player)) {
              boardArray[r][c] = 0;
              return c;
            }
            boardArray[r][c] = 0;
          }
        }
      }
      return aiEasyMove();
    }

    function updateStatus() {
      status.textContent = currentPlayer === 1 ? 'Your turn' : 'AI turn';
    }

    function endGame(message) {
      isGameOver = true;
      overlayMessage.textContent = message;
      overlay.style.display = 'flex';
    }

    function resetGame() {
      boardArray = Array(rows).fill().map(() => Array(cols).fill(0));
      currentPlayer = 1;
      isGameOver = false;
      initBoard();
      updateStatus();
      overlay.style.display = 'none';
    }

    playAgainButton.addEventListener('click', resetGame);

    window.onload = () => {
      initBoard();
      updateStatus();
    };
  </script>
</body>
</html>
